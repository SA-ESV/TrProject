# Разбор сценария

## Наименование UC
Возврат заказа Клиентом

## Код UC
UC-5

## Действующие лица:
* Клиент
* Администратор магазина
* Веб-сайт магазина (далее Система)
* Сервис платежей Payture 

## Триггер
Клиент возвращает заказ в магазин

## Предусловия
Клиент возвращает ранее оформленный заказ. 
<br>Возрат возможен только всего заказа, без частичного возврата.
<br>Администратор успешно авторизовался в системе.

## Постусловия
Успешно проведен возврат денежных средств Клиента в Payture
<br>В Системе успешно сохранен результат возврата

## Основной поток
1. Клиент возвращает заказ в магазин
2. Администратор магазина забирает заказ
3. Администратор магазина совершает поиск нужного заказа в Системе - вводит номер заказа (*возможно поиск по клиенту/дате/сумме*)
<br>*Система отображает найденный заказ*
4. Администратор магазина оформляет возврат на заказ в Системе
5. Администратор магазина оформляет возврат денежных средств Клиенту за заказ
6. Система удерживает с суммы заказа - суммы доставки
7. Система отправляет в Payture операцию возврата денежных средств по платежу Клиента (с учетом удержания суммы доставки)
8. Payture обрабатывает возврат
9. Payture передает в Систему результат обработки возврата
10. Система убеждается, что операция возврата прошла успешна
11. Система сохраняет результат возврата и отображает его Администратору магазина
12. Администратор магазина сообщает Клиент об успешном завершение возврата

## Расширения (Альтернатива, Исключения)
**3а. Нужный заказ не найден в Системе**
<br>3а.1 Система сообщает Администратору об отсутствии заказа и просит ввести новый номер заказа.
<br>3а.1.1 Администратор вводит новый номер, сценарий продолжается с шага 3.
<br>3а.1.2 Администратор отменяет поиск заказа. Сценарий завершается.

**4а. По возвращаемому заказу в Системе уже оформлен ранее возврат**
<br>4а.1 Система сообщает Администратору о статусе заказа и просит ввести новый номер заказа или отменить операцию.
<br>4а.1.1 Администратор вводит новый номер, сценарий продолжается с шага 3.
<br>4а.1.2 Администратор отменяет поиск заказа. Сценарий завершается.

**4б. Срок возрата по заказу уже истек**
<br>4б.1 Система сообщает Администратору о невозможности оформления возврата заказа и просит ввести новый номер заказа или отменить операцию.
<br>4б.1.1 Администратор вводит новый номер, сценарий продолжается с шага 3.
<br>4б.1.2 Администратор отменяет поиск заказа. Сценарий завершается.

**5а. Карта клиента, которой был оплачен заказ, заблокирована или утрачена**
<br>*для оформления возврата на другую карту необходимо ввести данные новой карты. Но в описании сервиса платежей не увидела возможности возврата по другим реквизитам.*

**6а. Сумма доставки не удерживается - Возврат выполняется до передачи заказа в доставку**
<br>6а.1 Система сообщает Администратору о том, что стоимость доставки не будет удержана с Клиента.
<br>6а.2 Администратор подтверждает информационное сообщение, сценарий продолжается с шага 7, но Система отправляет в Payture операцию возврата денежных средств по платежу Клиента без удержания суммы доставки.

**7а. Сервис платежей Payture недоступен**
<br>7а.1 Система сообщает Администратору о том, что сервис платежей недоступен. 
<br>7а.1.1 Администратор повторяет попытку возврата, сценарий продолжается с шага 3.
<br>7а.1.2 Администратор отменяет возврат. Сценарий завершается.

**10а. Статус платежа в Payture **не** Charged**
<br>10а.1 Система сообщает Администратору о том, что при попытке возврата произошла ошибка
<br>10а.1.1 Возврат выполняется в день оплаты. 
<br>10а.1.1.1 Предлагается разблокировать средства, а не оформить возрат
<br><br>10а.1.2 Сумма возврата превышает текущую сумму
<br>10а.1.2.1 Система сообщает Администратору подробности по ошибке. Сценарий завершается.
<br><br>10а.1.3 С момента оплаты прошло больше 180 дней
<br>10а.1.3.1 Система сообщает Администратору подробности по ошибке. Сценарий завершается.
